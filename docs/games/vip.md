# EaseCation VIP系统详细逻辑文档

## 目录

1. [系统概述](#系统概述)
2. [VIP等级体系](#vip等级体系)
3. [分数系统](#分数系统)
4. [升级与保级机制](#升级与保级机制)
5. [体验卡系统](#体验卡系统)
6. [目标任务系统](#目标任务系统)
7. [自动化处理机制](#自动化处理机制)
8. [老版本迁移逻辑](#老版本迁移逻辑)
9. [奖励与赠送机制](#奖励与赠送机制)
10. [关键业务流程](#关键业务流程)

---

## 系统概述

EaseCation的VIP系统是一个**基于分数积累的等级制度**，核心机制如下：

- 玩家通过完成各种目标任务获得分数
- 分数达到特定阈值后自动升级VIP等级
- 支持时间限制的VIP权限和体验卡机制
- 提供保级机制防止等级意外掉落

### 核心特性

- **5个VIP等级**：VIP0（普通用户）到VIP4（最高等级）
- **分数驱动**：通过完成任务获得分数来升级
- **时间限制**：VIP权限具有到期时间
- **保级机制**：防止VIP等级意外掉级
- **体验卡系统**：临时提升VIP等级体验
- **自动化处理**：系统自动处理升级、保级和降级
- **老版本兼容**：支持从旧VIP系统迁移

---

## VIP等级体系

### 等级配置

| VIP等级 | 升级所需分数 | 保级所需分数 | 升级后VIP天数 | 保级后VIP天数 | 降级后VIP天数 |
|---------|-------------|-------------|-------------|-------------|-------------|
| VIP0    | 60          | 0           | 0           | 0           | 0           |
| VIP1    | 1,280       | 80          | 15          | 31          | 7           |
| VIP2    | 5,200       | 900         | 180         | 180         | 7           |
| VIP3    | 12,880      | 2,380       | 180         | 365         | 7           |
| VIP4    | 无需升级     | 6,880       | 365         | 365         | 0           |

### 等级说明

- **VIP0（普通用户）**：起始等级，需要60分升级到VIP1
- **VIP1（初级VIP）**：获得基础VIP权限，15天有效期
- **VIP2（中级VIP）**：更多权限和特权，180天有效期
- **VIP3（高级VIP）**：高级权限，365天有效期
- **VIP4（顶级VIP）**：最高等级，365天有效期，无法继续升级

---

## 分数系统

### 分数概念

- **当前分数（points）**：玩家当前拥有的总分数
- **升级门槛（upgradeRequirement）**：升级到下一等级所需的总分数
- **保级门槛（preserveRequirement）**：保持当前等级所需的总分数

### 分数计算逻辑

- **升级门槛计算**：当前分数 + 当前等级配置的升级分数
- **保级门槛计算**：当前分数 + 当前等级配置的保级分数

### 分数获取方式

分数主要通过完成**目标任务（Objectives）**获得，每个任务完成后会获得相应的分数奖励。

---

## 升级与保级机制

### 核心状态重新计算机制

VIP系统的核心是`recalculateReal()`方法，它在每次状态更新时执行完整的等级评估：

**执行时机**：
- 玩家登录时
- 任务完成获得分数时
- 定时系统检查时
- 手动调用更新时

**处理顺序**：
1. **优先处理到期情况**：检查VIP是否已到期，执行保级或降级
2. **然后处理升级情况**：检查分数是否达到升级门槛，执行升级

### 升级机制详解

**升级触发条件**：
- 当前分数 ≥ 升级门槛
- 存在更高的VIP等级（VIP4为最高等级）

**升级处理流程**：
1. **等级提升**：将真实VIP等级提升1级
2. **设置到期时间**：根据新等级的`upgradeVIPDays`配置设置到期日期
3. **重新计算门槛**：
   - 新升级门槛 = 旧升级门槛 + 新等级的升级分数要求
   - 新保级门槛 = 旧升级门槛 + 新等级的保级分数要求

**连续升级支持**：
- 系统支持一次性连续升多级
- 使用`while`循环持续检查升级条件
- 直到不满足升级条件为止

**升级后的VIP天数规则**：
- VIP0 → VIP1：0天（立即生效）
- VIP1升级：获得15天VIP时间
- VIP2升级：获得180天VIP时间
- VIP3升级：获得180天VIP时间
- VIP4升级：获得365天VIP时间

### 保级机制详解

**保级触发条件**：
- VIP已经到期（当前时间 ≥ VIP到期时间）
- 当前分数 ≥ 保级门槛

**保级处理流程**：
1. **延长VIP时间**：根据当前等级的`preserveVIPDays`配置延长到期日期
2. **提高保级门槛**：新保级门槛 = 旧保级门槛 + 当前等级的保级分数要求
3. **保持等级不变**：VIP等级不发生变化
4. **记录保级事件**：生成保级事件记录

**保级天数配置**：
- VIP1保级：获得31天延期
- VIP2保级：获得180天延期
- VIP3保级：获得365天延期
- VIP4保级：获得365天延期

**保级门槛递增机制**：
- 每次成功保级后，保级门槛都会增加
- 防止玩家无限制地以最低分数保级
- 鼓励玩家持续活跃获得更多分数

### 降级机制详解

**降级触发条件**：
- VIP已经到期
- 当前分数 < 保级门槛
- 存在更低的VIP等级（VIP0为最低等级）

**降级处理流程**：
1. **等级降低**：将真实VIP等级降低1级
2. **设置缓冲时间**：根据新等级的`downgradeVIPDays`配置给予缓冲期
3. **重新计算门槛**：基于当前分数重新计算升级和保级门槛
4. **记录降级事件**：生成降级事件记录

**降级缓冲机制**：
- VIP1降级到VIP0：获得7天缓冲期
- VIP2降级到VIP1：获得7天缓冲期  
- VIP3降级到VIP2：获得7天缓冲期
- VIP4不会自动降级（downgradeVIPDays = 0）

**门槛重置逻辑**：
- 升级门槛 = 当前分数 + 新等级的升级分数要求
- 保级门槛 = 当前分数 + 新等级的保级分数要求
- 重置确保玩家在新等级下有合理的升级和保级目标

### 事件记录机制

**事件快照系统**：
- 每次等级变化前记录`before`状态快照
- 执行等级变化操作
- 记录`after`状态快照
- 生成完整的事件记录

**记录的状态信息**：
- VIP等级
- VIP到期时间
- 当前分数
- 升级门槛
- 保级门槛

**事件类型**：
- `UPGRADE`：升级事件
- `PRESERVE`：保级事件  
- `DOWNGRADE`：降级事件

### 特殊操作机制

**forceSet强制设置**：
- 管理员工具或迁移过程中使用
- 直接设置VIP等级和到期时间
- 基于当前分数重新计算门槛
- 不经过正常的升级/保级流程

**等级有效性检查**：
- 所有等级操作都会验证目标等级的有效性
- 等级范围：0 ≤ level < 总等级数（当前为5级：0-4）
- 无效等级的操作会被忽略

**数据一致性保证**：
- 所有状态变更都会标记`isDirty = true`
- 确保数据库更新操作被正确执行
- 通过异步Promise确保操作的原子性

---

## 体验卡系统

### 体验卡概念

体验卡（Trial）是一种**临时VIP等级提升机制**，核心特点：
- 允许玩家临时享受更高等级的VIP权限
- 不影响玩家的真实VIP等级和升级进度
- 具有明确的到期时间限制

### 体验卡属性

- **体验等级（trialLevel）**：体验卡提供的VIP等级
- **体验到期时间（trialExpiry）**：体验卡的有效期

### 最终VIP等级计算

玩家实际享受的VIP等级 = max(真实VIP等级, 体验卡等级)

### 体验卡应用规则

1. **高等级覆盖**：新体验卡等级更高时，直接应用新的等级和到期时间
2. **同等级延长**：同等级体验卡可以延长到期时间
3. **低等级忽略**：低等级体验卡被忽略，不会降低当前体验等级

### 体验卡到期处理

- 系统自动检测体验卡是否到期
- 到期后自动清除体验等级和到期时间
- 玩家恢复到真实VIP等级

---

## 目标任务系统

### 任务类型配置

目前系统配置了3种基础任务：

**daily-play（每日游戏）**
- 周期：每日重置
- 仅保级阶段可用
- 完成1次游戏获得5分

**buy-credits（购买点券）**
- 周期：无限制
- 购买100点券获得7分

**use-credits（使用点券）**
- 周期：无限制  
- 使用100点券获得3分

### 任务周期类型

- **DAILY**：每日重置的任务，到期后进度清零
- **UNLIMITED**：无限制任务，进度累积不重置

### 任务执行流程

1. **检查任务可用性**：判断任务是否可以执行
2. **更新任务周期**：处理到期任务的重置
3. **累积进度**：添加新的进度值
4. **计算奖励**：根据进度计算应获得的奖励次数
5. **发放分数**：将分数奖励添加到玩家账户

### 任务可用性规则

- **保级阶段限制**：标记为"仅保级阶段"的任务，当玩家分数超过保级门槛时不可用
- **进度限制**：任务进度达到周期上限时不可用，直到周期重置
- **周期重置**：每日任务在新的一天开始时重置进度

---

## 自动化处理机制

### 定时更新任务

系统通过定时任务机制实现自动化处理：
- 每100个游戏tick执行一次缓存清理
- 清理离线玩家的VIP对象缓存
- 释放内存资源，提高系统性能

### 玩家VIP状态更新

每次VIP状态更新时，系统执行以下完整流程：

1. **更新目标任务**：检查和更新所有目标任务的周期状态
2. **重新计算真实VIP等级**：根据当前时间和分数重新评估VIP等级
3. **重新计算体验卡状态**：检查体验卡是否到期
4. **保存数据库更改**：将所有变更持久化到数据库
5. **触发更新事件**：发送VIP更新事件通知其他系统
6. **记录事件日志**：将升级、保级、降级等事件记录到日志

### 状态重新计算逻辑

**VIP到期处理**：
- 检查VIP是否已经到期
- 如果分数满足保级要求，执行保级逻辑
- 如果分数不足且有更低等级，执行降级逻辑

**升级检查**：
- 检查是否存在更高等级
- 如果分数达到升级门槛，自动执行升级逻辑
- 支持连续升级（一次性升多级）

---

## 老版本迁移逻辑

### 迁移触发条件

- 玩家首次登录新VIP系统时自动检查
- 通过检查`extra.migrate`字段判断是否已经迁移
- 每个玩家只能迁移一次，避免重复迁移

### VIP等级迁移

系统根据玩家旧VIP数据计算迁移奖励：

**计算依据**：
- 旧VIP等级（1-4级）
- VIP剩余天数
- 根据剩余时间长短给予不同等级的新VIP

**迁移规则示例**：
- VIP1剩余1-44天 → 新VIP1（30天）
- VIP1剩余45-179天 → 新VIP1（45天）
- VIP1剩余180-365天 → 新VIP2（30天）
- VIP1剩余366天以上 → 新VIP2（45天）

### 经验等级迁移

根据玩家的**经验等级**额外给予VIP奖励：

**迁移标准**：
- 经验等级500+ → 新VIP4（14天）
- 经验等级1000+ → 新VIP4（30天）
- 经验等级2000+ → 新VIP4（60天）

### 迁移执行流程

1. **检查迁移资格**：验证玩家是否已经迁移过
2. **计算VIP迁移奖励**：根据旧VIP等级和剩余时间计算
3. **计算经验迁移奖励**：根据经验等级计算额外奖励
4. **合并奖励**：将两种迁移奖励合并
5. **应用奖励**：设置新的VIP等级和到期时间
6. **发放物品**：给予相应的纪念物品（如传统VIP前缀）
7. **标记完成**：在数据中标记已迁移，防止重复

---

## 奖励与赠送机制

### VIP等级奖励

当玩家VIP等级升级后，系统会自动检查并赠送相应的奖励：

- **VIP2及以上**：赠送攻击粒子特效包（包含多种攻击特效）
- **VIP3及以上**：赠送免费月卡（签到通行证）
- **VIP4**：赠送4D装扮（RGB翅膀）

### 奖励发放机制

**自动检查**：
- 每次VIP等级更新时自动触发奖励检查
- 检查玩家当前真实VIP等级是否达到奖励要求
- 只有等级达标且未拥有相应物品的玩家才会获得奖励

**奖励类型**：
- 攻击特效：包含15种不同的攻击粒子特效
- 月卡：免费的签到通行证，提供每日签到奖励
- 4D装扮：RGB彩虹翅膀等高级装扮

### 奖励时长计算规则

**永久VIP**：
- 如果玩家VIP没有到期时间，给予永久物品

**限时VIP**：
- 奖励物品的到期时间与VIP到期时间同步
- 如果物品已存在且未到期，计算需要延长的时间
- 系统会额外增加10秒缓冲时间，确保物品不会比VIP提前过期

**智能判断**：
- 已拥有永久物品的玩家不会重复获得
- 已拥有且未到期的限时物品会延长到VIP到期时间

---

## 关键业务流程

### 新玩家首次登录流程

1. **创建VIP对象**：为新玩家创建初始VIP0等级
2. **初始化分数**：设置初始分数为0，升级门槛为60分
3. **检查老版本迁移**：如果是从旧系统迁移的玩家，执行迁移逻辑
4. **缓存VIP对象**：将VIP对象加载到内存缓存中

### 玩家完成任务流程

1. **任务进度通知**：游戏系统调用`notifyProgress()`更新任务进度
2. **检查任务可用性**：验证任务是否可以执行（保级限制、周期限制等）
3. **更新任务周期**：检查并处理到期任务的重置
4. **计算奖励分数**：根据进度增量计算获得的分数奖励
5. **添加分数**：将奖励分数添加到玩家总分数
6. **触发VIP更新**：检查是否满足升级条件，自动处理等级变化

### VIP到期处理流程

1. **定时检查**：系统定时检查所有在线玩家的VIP状态
2. **检测到期**：发现VIP已到期的玩家
3. **分数判断**：检查玩家当前分数是否满足保级要求
4. **执行保级或降级**：
   - 分数足够：执行保级，延长VIP时间，增加保级门槛
   - 分数不足：执行降级，降低VIP等级，设置缓冲时间
5. **记录事件**：将保级或降级事件记录到日志
6. **通知玩家**：向玩家发送相应的通知消息

## 技术实现架构

### 核心类设计

- **ECVIPManager**：VIP系统管理器，负责玩家VIP对象的缓存和管理
- **ECVIP**：VIP对象类，包含玩家的所有VIP相关信息和业务逻辑
- **ECVIP.Objective**：目标任务内部类，处理任务进度和奖励逻辑
- **ECVIPConfig**：VIP系统配置类，从JSON配置文件加载
- **ECVIPEvent**：VIP事件类，记录升级、保级、降级等事件

### 数据存储结构

VIP数据通过`ECPermission`系统存储在MySQL数据库中，主要字段包括：
- **points**：当前分数
- **upgradeRequirement**：升级门槛
- **preserveRequirement**：保级门槛
- **trialLevel**：体验等级
- **trialExpiry**：体验到期时间
- **objectives**：目标任务进度数据
- **extra**：额外数据（如迁移标记）

### 异步处理架构

- 系统大量使用`AsyncPromise`进行异步处理
- 确保数据库操作不阻塞主线程
- 支持链式调用和错误处理
- 提供高并发处理能力

### 缓存机制

- ECVIPManager维护在线玩家的VIP对象缓存
- 定时清理离线玩家缓存，释放内存资源
- 使用双重缓存策略防止并发创建相同对象
- 提高访问性能，减少数据库查询

---

## 总结

EaseCation的VIP系统是一个**复杂而完整的等级制度**，涵盖了从分数积累、等级升级、保级机制到体验卡系统的各个方面。系统设计考虑了用户体验的方方面面：

1. **灵活的升级路径**：通过多种任务获得分数，给玩家多样化的升级选择
2. **保级机制**：防止玩家因为短期不活跃而失去VIP权限  
3. **体验卡系统**：让玩家可以临时体验更高等级的权限
4. **自动化处理**：减少人工干预，系统自动处理各种状态转换
5. **向后兼容**：支持从旧VIP系统平滑迁移
6. **丰富的奖励**：不同等级提供不同的专属奖励和特权

该系统的技术实现使用了现代化的异步编程模式，确保了高性能和可扩展性，是一个值得学习和参考的复杂业务系统设计案例。