# EaseCation服务器后端架构介绍

## 概述
EaseCation是一个大型Minecraft基岩版小游戏服务器，采用分布式架构设计，能够同时支持数千名玩家在线游戏。

## 整体架构设计

### 三层架构模式
我们的服务器采用三层架构，每一层都有不同的职责：

```
玩家客户端
     ↓
1. 网络代理层 (Nemisys) - 负责玩家连接和流量分发
     ↓
2. API控制层 (CodeFunCore API) - 负责服务器管理和数据存储
     ↓  
3. 游戏服务层 (Nukkit) - 负责具体的游戏逻辑
```

![架构图](/images/6915b0c0-458b-11e8-88b9-c13ac9b0b3a1.png)

### 各层详细说明

#### 1. 网络代理层 (Nemisys)
- **作用**: 作为玩家进入服务器的第一道门户
- **功能**: 
  - 接收玩家连接请求
  - 将玩家分配到合适的游戏服务器
  - 缓存游戏数据，提升传输效率
- **类比**: 就像商场的总服务台，指引顾客去不同的店铺

#### 2. API控制层 (CodeFunCore API)
- **作用**: 整个服务器集群的"大脑"
- **功能**:
  - 管理所有游戏服务器
  - 存储玩家数据和游戏记录
  - 决定玩家应该进入哪个服务器
  - 处理跨服务器的通信
- **类比**: 就像商场的管理中心，协调各个店铺的运营

#### 3. 游戏服务层 (Nukkit)
- **作用**: 实际运行游戏的地方
- **功能**:
  - 运行具体的小游戏（如起床战争、空岛战争等）
  - 处理玩家在游戏中的所有操作
  - 管理游戏世界和玩家状态
- **类比**: 就像商场里的各个专门店铺，提供具体的服务

## 服务器通信协议

### Synapse协议
我们使用自主开发的**Synapse协议**来实现各层之间的通信：

- **协议类型**: 基于TCP的自定义协议
- **通信方向**: Nukkit(客户端) ↔ Nemisys(服务端)
- **主要功能**: 
  - 传输玩家数据
  - 同步游戏状态
  - 处理服务器切换

### 玩家登录流程
![登录流程图](/images/6915b0c0-458b-11e8-88b9-c13ac9b0b3a1.png)

1. 玩家连接到Nemisys代理服务器
2. Nemisys向API服务器请求玩家应该进入哪个服务器
3. API服务器根据服务器负载情况，分配最合适的Nukkit服务器
4. Nemisys将玩家转发到指定的Nukkit服务器
5. 玩家开始游戏

## 游戏服务器设计

### 灵活的模块化设计
每个Nukkit服务器都可以运行不同类型的游戏内容：

#### 大厅服务器
- **功能**: 玩家聚集和游戏选择的地方
- **实现**: 继承`ECLobby`抽象类
- **特点**: 玩家可以在这里选择想要游戏的模式

#### 游戏房间服务器  
- **功能**: 运行具体的小游戏
- **实现**: 继承`Stage`抽象类
- **特点**: 每个房间可以运行不同的游戏模式

### 服务器配置的灵活性

一个Nukkit服务器可以根据需要配置成：

| 配置类型 | 说明 | 适用场景 |
|---------|------|---------|
| 专用大厅服务器 | 只运行大厅功能 | 玩家数量多，需要专门的分流 |
| 专用游戏服务器 | 只运行一种游戏 | 热门游戏，需要专门的服务器资源 |
| 混合服务器 | 同时运行大厅和多种游戏 | 小规模部署，节省服务器资源 |

### 自动化管理

#### 大厅管理
- 大厅插件加载后，自动向API服务器注册
- API服务器自动分配玩家到负载较低的大厅

#### 游戏房间管理  
- 游戏插件加载后，向API服务器报告可提供的游戏类型
- API服务器根据玩家需求和服务器负载，动态创建新的游戏房间
- 游戏结束后，房间可以被回收和重复利用

## 架构优势

### 1. 高可用性
- 单个服务器故障不会影响整个系统
- 可以实时添加或移除服务器

### 2. 高扩展性  
- 可以根据玩家数量动态调整服务器数量
- 支持不同类型的游戏服务器混合部署

### 3. 负载均衡
- API服务器智能分配玩家到最合适的服务器
- 避免某些服务器过载而其他服务器空闲

### 4. 模块化设计
- 新游戏可以作为独立插件开发
- 便于维护和更新

---

这种架构设计让EC能够稳定地为大量玩家提供流畅的游戏体验，同时保持系统的灵活性和可维护性。