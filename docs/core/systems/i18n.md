# CodeFunCore 多语言系统详解

## 概述

CodeFunCore的多语言系统为EaseCation服务器提供了完整的国际化支持，支持中文、英文、葡萄牙语、西班牙语、日语、繁体中文等多种语言。系统通过TranslateMessage类实现动态文本翻译，支持参数替换和条件显示。

## TranslateMessage核心类

### 基础结构
```java
public class TranslateMessage {
    public final static TranslateMessage EMPTY = new TranslateMessage("").setUseDictionary(false);
    
    public final String msg;                    // 翻译键或原始消息
    public Map<String, String> array = new HashMap<>();  // 参数映射
    public boolean useDictionary = true;        // 是否使用字典翻译
    public boolean light2dark = false;          // 浅色转深色
    public boolean dark2light = false;          // 深色转浅色
    
    public TranslateMessage(String msg, Map<String, String> array) {
        this.msg = msg;
        this.array = array;
    }
    
    public TranslateMessage(String msg) {
        this.msg = msg;
    }
    
    public TranslateMessage(String msg, String... array) {
        Objects.requireNonNull(msg);
        Map<String, String> paramsMap = new HashMap<>();
        if (array != null) {
            for (int i = 0; i < array.length; i++) {
                paramsMap.put("{" + i + "}", array[i]);
            }
        }
        this.msg = msg;
        this.array = paramsMap;
    }
}
```

### 参数管理
```java
public class TranslateMessage {
    /**
     * 检查是否包含指定参数
     */
    public boolean hasParam(String from) {
        return this.array.containsKey(from);
    }
    
    /**
     * 添加参数
     */
    public TranslateMessage putParam(String from, String to) {
        this.array.put(from, to);
        return this;
    }
    
    /**
     * 移除参数
     */
    public TranslateMessage removeParam(String from) {
        this.array.remove(from);
        return this;
    }
    
    /**
     * 清空所有参数
     */
    public TranslateMessage clearParams() {
        this.array.clear();
        return this;
    }
    
    /**
     * 设置是否使用字典翻译
     */
    public TranslateMessage setUseDictionary(boolean useDictionary) {
        this.useDictionary = useDictionary;
        return this;
    }
    
    /**
     * 设置颜色转换模式
     */
    public TranslateMessage setLight2Dark(boolean light2dark) {
        this.light2dark = light2dark;
        return this;
    }
    
    public TranslateMessage setDark2Light(boolean dark2light) {
        this.dark2light = dark2light;
        return this;
    }
}
```

## 翻译处理

### 翻译方法
```java
public class TranslateMessage {
    /**
     * 翻译消息给指定玩家
     */
    public String trans(ECPlayer player) {
        if (player == null) {
            return trans(Locale.SIMPLIFIED_CHINESE);
        }
        return trans(player.getLocale());
    }
    
    /**
     * 翻译消息到指定语言
     */
    public String trans(Locale locale) {
        if (!useDictionary) {
            return processText(msg);
        }
        
        String translated = Dictionary.get(locale, msg, array);
        return processText(translated);
    }
    
    /**
     * 处理文本（颜色转换等）
     */
    private String processText(String text) {
        if (text == null) {
            return "";
        }
        
        // 处理颜色转换
        if (light2dark) {
            text = TextUtil.light2dark(text);
        } else if (dark2light) {
            text = TextUtil.dark2light(text);
        }
        
        return text;
    }
    
    /**
     * 翻译为纯文本（无颜色代码）
     */
    public String transPlain(ECPlayer player) {
        String translated = trans(player);
        return TextUtil.clean(translated);
    }
    
    /**
     * 翻译为HTML格式
     */
    public String transHTML(ECPlayer player) {
        String translated = trans(player);
        return TextUtil.toHTML(translated);
    }
}
```

## Dictionary字典系统

### 字典接口
```java
public class Dictionary {
    private static Map<Locale, Map<String, String>> dictionary = new ConcurrentHashMap<>();
    
    /**
     * 获取翻译文本
     */
    public static String get(Locale locale, String key, Object... args) {
        Map<String, String> params = new HashMap<>();
        if (args != null) {
            for (int i = 0; i < args.length; i++) {
                params.put("{" + i + "}", String.valueOf(args[i]));
            }
        }
        return get(locale, key, params);
    }
    
    /**
     * 翻译文本（带参数映射）
     */
    public static String get(Locale locale, String key, Map<String, String> params) {
        if (locale == null) {
            locale = Locale.SIMPLIFIED_CHINESE;
        }
        
        Map<String, String> langMap = dictionary.get(locale);
        if (langMap == null) {
            langMap = dictionary.get(Locale.SIMPLIFIED_CHINESE); // 默认中文
        }
        
        String translated = langMap != null ? langMap.get(key) : key;
        if (translated == null) {
            translated = key;
        }
        
        // 替换参数
        if (params != null && !params.isEmpty()) {
            for (Map.Entry<String, String> entry : params.entrySet()) {
                translated = translated.replace(entry.getKey(), entry.getValue());
            }
        }
        
        return translated;
    }
    
    // Dictionary类使用LanguageProvider加载翻译数据
    // 支持MySQL数据库和HTTP来源的语言配置
    // 实际实现包含缓存机制和多种语言回退策略
}
```

## 客户端字典系统

### ClientDictionary类
```java
public final class ClientDictionary {
    private static final Map<Locale, Map<String, String>> entries = new HashMap<>();
    
    /**
     * 加载所有语言文件
     */
    public static void loadAll() {
        try {
            loadLangFile(Locale.ENGLISH, "/net/easecation/codefuncore/dictionary/en_US.lang");
            loadLangFile(Locale.SIMPLIFIED_CHINESE, "/net/easecation/codefuncore/dictionary/zh_CN.lang");
        } catch (IOException e) {
            CodeFunCore.getInstance().getLogger().alert("Failed to load language files.");
        }
    }
    
    /**
     * 从资源文件加载语言配置
     */
    private static void loadLangFile(Locale locale, String path) throws IOException {
        Properties properties = new Properties();
        try (InputStream inputStream = ClientDictionary.class.getResourceAsStream(path);
             InputStreamReader reader = new InputStreamReader(inputStream, StandardCharsets.UTF_8)) {
            properties.load(reader);
        }
        
        Map<String, String> langMap = new HashMap<>();
        for (String key : properties.stringPropertyNames()) {
            langMap.put(key, properties.getProperty(key));
        }
        entries.put(locale, langMap);
    }
    
    /**
     * 获取指定语言的翻译条目
     */
    public static Map<String, String> getEntries(Locale locale) {
        return entries.get(locale);
    }
}
```

## 文本处理工具

### TextUtil工具类
```java
public class TextUtil {
    /**
     * 清理颜色代码
     */
    public static String clean(String text) {
        if (text == null) return "";
        return text.replaceAll("§[0-9a-fk-or]", "");
    }
    
    /**
     * 转换为HTML格式
     */
    public static String toHTML(String text) {
        if (text == null) return "";
        
        text = text.replace("§0", "<span style=\"color:#000000\">")
                  .replace("§1", "<span style=\"color:#0000AA\">")
                  .replace("§2", "<span style=\"color:#00AA00\">")
                  .replace("§3", "<span style=\"color:#00AAAA\">")
                  .replace("§4", "<span style=\"color:#AA0000\">")
                  .replace("§5", "<span style=\"color:#AA00AA\">")
                  .replace("§6", "<span style=\"color:#FFAA00\">")
                  .replace("§7", "<span style=\"color:#AAAAAA\">")
                  .replace("§8", "<span style=\"color:#555555\">")
                  .replace("§9", "<span style=\"color:#5555FF\">")
                  .replace("§a", "<span style=\"color:#55FF55\">")
                  .replace("§b", "<span style=\"color:#55FFFF\">")
                  .replace("§c", "<span style=\"color:#FF5555\">")
                  .replace("§d", "<span style=\"color:#FF55FF\">")
                  .replace("§e", "<span style=\"color:#FFFF55\">")
                  .replace("§f", "<span style=\"color:#FFFFFF\">")
                  .replace("§l", "<b>")
                  .replace("§o", "<i>")
                  .replace("§n", "<u>")
                  .replace("§m", "<s>")
                  .replace("§r", "</span>");
        
        return text;
    }
    
    /**
     * 浅色转深色
     */
    public static String light2dark(String text) {
        if (text == null) return "";
        
        return text.replace("§f", "§0")  // 白色 -> 黑色
                  .replace("§7", "§8")  // 浅灰 -> 深灰
                  .replace("§e", "§6")  // 黄色 -> 金色
                  .replace("§b", "§3")  // 浅蓝 -> 深蓝
                  .replace("§d", "§5")  // 粉色 -> 紫色
                  .replace("§a", "§2"); // 浅绿 -> 深绿
    }
    
    /**
     * 深色转浅色
     */
    public static String dark2light(String text) {
        if (text == null) return "";
        
        return text.replace("§0", "§f")  // 黑色 -> 白色
                  .replace("§8", "§7")  // 深灰 -> 浅灰
                  .replace("§6", "§e")  // 金色 -> 黄色
                  .replace("§3", "§b")  // 深蓝 -> 浅蓝
                  .replace("§5", "§d")  // 紫色 -> 粉色
                  .replace("§2", "§a"); // 深绿 -> 浅绿
    }
    
    /**
     * 截断文本到指定长度
     */
    public static String truncate(String text, int maxLength) {
        if (text == null) return "";
        if (text.length() <= maxLength) return text;
        
        return text.substring(0, maxLength - 3) + "...";
    }
    
    /**
     * 换行文本
     */
    public static String wrapText(String text, int lineLength) {
        if (text == null) return "";
        
        StringBuilder result = new StringBuilder();
        String[] words = text.split(" ");
        int currentLength = 0;
        
        for (String word : words) {
            if (currentLength + word.length() > lineLength) {
                result.append("\n");
                currentLength = 0;
            }
            
            if (currentLength > 0) {
                result.append(" ");
                currentLength++;
            }
            
            result.append(word);
            currentLength += word.length();
        }
        
        return result.toString();
    }
}
```

## 使用示例

### 基础使用

```java
// 简单消息发送
TranslateMessage welcome = new TranslateMessage("welcome.message");
player.sendMessage(welcome);

// 带参数的消息
TranslateMessage withParams = new TranslateMessage("welcome.player", player.getName());
player.sendMessage(withParams);

// 复杂参数消息
TranslateMessage complex = new TranslateMessage("game.start.info")
    .putParam("{game}", "BedWars")
    .putParam("{players}", String.valueOf(8))
    .putParam("{map}", "Village");
player.sendMessage(complex);

// 颜色转换示例
TranslateMessage result = new TranslateMessage("game.result", 
    String.valueOf(rank), String.valueOf(score));
if (rank == 1) {
    // 保持亮色（不转换）
} else {
    result.light2dark();          // 转为暗色
}
player.sendMessage(result);
```

### 批量消息发送

```java
// 向Stage中所有玩家发送消息
public void broadcastToStage(Stage stage, TranslateMessage message) {
    for (ECPlayer player : stage.getPlayers()) {
        player.sendMessage(message);
    }
}

// 全局广播
public void broadcastGlobal(TranslateMessage message) {
    for (Player player : Server.getInstance().getOnlinePlayers().values()) {
        if (player instanceof ECPlayer ecPlayer) {
            ecPlayer.sendMessage(message);
        }
    }
}
```

### 条件消息发送

```java
// VIP消息示例
if (player.isVIP()) {
    TranslateMessage vipMsg = new TranslateMessage("vip.welcome", 
        String.valueOf(player.getVIPLevel()));
    player.sendMessage(vipMsg);
} else {
    TranslateMessage normalMsg = new TranslateMessage("normal.welcome");
    player.sendMessage(normalMsg);
}

// 语言特定消息
Locale locale = player.getLocale();
if (locale.getLanguage().equals("zh")) {
    player.sendMessage(new TranslateMessage("chinese.special"));
} else {
    player.sendMessage(new TranslateMessage("general.message"));
}
```

## 数据库结构

### 语言配置表
```sql
CREATE TABLE `ec2017`.`cfgLanguage` (
    `key` VARCHAR(255) PRIMARY KEY,
    `en` TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
    `zh` TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
    `pt` TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
    `es` TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
    `ja` TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
    `zh_TW` TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci
);
```

### 资源文件结构

客户端字典使用资源文件而非数据库：
- `/net/easecation/codefuncore/dictionary/en_US.lang` - 英文配置
- `/net/easecation/codefuncore/dictionary/zh_CN.lang` - 中文配置

### 添加翻译数据
```sql
-- 示例翻译数据
INSERT INTO ec2017.cfgLanguage (`key`, en, zh, pt, es, ja, zh_TW) VALUES 
('welcome.message', 'Welcome to EaseCation!', '欢迎来到网易我的世界!', 'Bem-vindo ao EaseCation!', '¡Bienvenido a EaseCation!', 'EaseCationへようこそ！', '歡迎來到網易我的世界!'),
('game.start', 'Game Started!', '游戏开始！', 'Jogo Iniciado!', '¡Juego Iniciado!', 'ゲーム開始！', '遊戲開始！'),
('game.end', 'Game Over', '游戏结束', 'Fim de Jogo', 'Fin del Juego', 'ゲーム終了', '遊戲結束');
```

## 最佳实践

### 翻译键命名规范
- 使用小写字母和点分隔符
- 采用层次结构：`模块.功能.具体内容`
- 示例：`bedwars.game.start`, `lobby.welcome.message`

### 参数使用建议
- 使用有意义的参数名：`{player}`, `{score}` 而不是 `{0}`, `{1}`
- 避免在翻译文本中硬编码数字和名称
- 对于复杂格式，考虑拆分为多个翻译键

### 性能优化
- 在服务器启动时预加载字典
- 使用缓存避免重复数据库查询
- 定期清理不使用的翻译键

### 多语言测试
- 确保所有支持的语言都有对应翻译
- 测试参数替换在不同语言下的表现
- 注意不同语言的文本长度差异